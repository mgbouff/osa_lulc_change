---
title: "Study Area by Region"
author: "Marie Bouffard"
date: "5/5/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

#---------------------------------------
# Load packages
#---------------------------------------
library(tidyverse)
library(here)
library(janitor)
library(ggsankey)
library(naniar)

#---------------------------------------
# Read in Data
#---------------------------------------

# Corcovado
raw_corcovado_87_98 <- read.csv(here("Soroush", "data_corcovado_87_98.csv")) %>% 
  clean_names()

raw_corcovado_98_19 <- read.csv(here("Soroush", "data_corcovado_98_19.csv")) %>% 
  clean_names()

# Fbs
raw_fbs_87_98 <- read.csv(here("Soroush", "data_fbs_87_98.csv")) %>% 
  clean_names()

raw_fbs_98_19 <- read.csv(here("Soroush", "data_fbs_98_19.csv")) %>% 
  clean_names()

# fonafifo
raw_fonafifo_87_98 <- read.csv(here("Soroush", "data_fonafifo_87_98.csv")) %>% 
  clean_names()

raw_fonafifo_98_19 <- read.csv(here("Soroush", "data_fonafifo_98_19.csv")) %>% 
  clean_names()

# Golfo
raw_golfo_87_98 <- read.csv(here("Soroush", "data_golfo_87_98.csv")) %>% 
  clean_names()

raw_golfo_98_19 <- read.csv(here("Soroush", "data_golfo_98_19.csv")) %>% 
  clean_names()

# Peninsula
raw_peninsula_87_98 <- read.csv(here("Soroush", "data_peninsula_87_98.csv")) %>% 
  clean_names()

raw_peninsula_98_19 <- read.csv(here("Soroush", "data_peninsula_98_19.csv")) %>% 
  clean_names()

# Piedras
raw_piedras_87_98 <- read.csv(here("Soroush", "data_piedras_87_98.csv")) %>% 
  clean_names()

raw_piedras_98_19 <- read.csv(here("Soroush", "data_piedras_98_19.csv")) %>% 
  clean_names()

# Terra
raw_terrao_87_98 <- read.csv(here("Soroush", "data_terra_87_98.csv")) %>% 
  clean_names()

raw_terra_98_19 <- read.csv(here("Soroush", "data_terra_98_19.csv")) %>% 
  clean_names()

#---------------------------------------
# Pallets
#---------------------------------------
class_pallete <- c("#feebbe", # Exposed Soil
                   "#287404", # Forest
                   "#e9ffbe", # Grassland
                   "#74ffdf", # Mangrove
                   "#ffff01", # Palm
                   "#e60f03", # Teak
                   "#0d5de6", # Water
                   "#bed2ff" # Wetland
                   )
```


### Corcovado

```{r, cache=TRUE}
#---------------------------------------
# Tidy Data
#---------------------------------------
#1987 to 1998
corcovado_tidy_87_98 <- raw_corcovado_87_98 %>% 
    pivot_longer(!land_use:area_starting_year, names_to = "lu_1998",
               values_to = "change") %>% 
  rename("lu_1987" = land_use) %>% 
  mutate(lu_1998 = case_when(
    lu_1998 == "palm" ~ "Palm",
    lu_1998 == "mangrove" ~ "Mangrove",
    lu_1998 == "water" ~ "Water",
    lu_1998 == "grassland" ~ "Grassland",
    lu_1998 == "exposed_soil_urban" ~ "Exposed soil / Urban",
    lu_1998 == "primary_forest" ~ "Forest",
    lu_1998 == "teak_melina" ~ "Teak / Melina",
    lu_1998 == "wetland" ~ "Wetland")) %>% 
    select(lu_1987, lu_1998, change) 

#1998 to 2019
corcovado_tidy_98_19 <- raw_corcovado_98_19 %>% 
    pivot_longer(!land_use:area_starting_year, names_to = "lu_2019",
               values_to = "change") %>% 
  rename("lu_1998" = land_use) %>% 
  mutate(lu_2019 = case_when(
    lu_2019 == "palm" ~ "Palm",
    lu_2019 == "mangrove" ~ "Mangrove",
    lu_2019 == "water" ~ "Water",
    lu_2019 == "grassland" ~ "Grassland",
    lu_2019 == "exposed_soil_urban" ~ "Exposed soil / Urban",
    lu_2019 == "primary_forest" ~ "Forest",
    lu_2019 == "teak_melina" ~ "Teak / Melina",
    lu_2019 == "wetland" ~ "Wetland")) %>% 
    select(lu_1998, lu_2019, change) 

#---------------------------------------
# Uncount
#---------------------------------------
# 1987 to 1998
corcovado_uncount_87_98 <- corcovado_tidy_87_98 %>% 
  mutate(change = round(change, digits = 0)) %>% 
  uncount(change)

# 1998 to 2019
corcovado_uncount_98_19 <- corcovado_tidy_98_19 %>% 
  mutate(change = round(change, digits = 0)) %>%
  uncount(change)

#---------------------------------------
# Make long
#---------------------------------------
# 1987 to 1998
# corcovado_long_87_98 <- corcovado_uncount_87_98 %>% 
#   make_long(lu_1987:lu_1998)

# 1998 to 2019
# corcovado_long_98_19 <- corcovado_uncount_98_19 %>% 
#   make_long(lu_1998:lu_2019)

#---------------------------------------
# Combine
#---------------------------------------
# Export to run combiner.exe
# write.csv(corcovado_uncount_87_98,"set1.csv")
# write.csv(corcovado_uncount_98_19,"set2.csv")

# Read in combined csvs
corcovado_combined <- read.csv(here("Intermediate Data", "Corcovado", "combinedSet.csv"))

# Make long
corcovado_long_combined <- corcovado_combined %>% 
  make_long(lu_1987:lu_2019)

```

### FBS

```{r, cache=TRUE}
#---------------------------------------
# Tidy Data
#---------------------------------------
#1987 to 1998
fbs_tidy_87_98 <- raw_fbs_87_98 %>% 
    pivot_longer(!land_use:area_starting_year, names_to = "lu_1998",
               values_to = "change") %>% 
  rename("lu_1987" = land_use) %>% 
  mutate(lu_1998 = case_when(
    lu_1998 == "palm" ~ "Palm",
    lu_1998 == "mangrove" ~ "Mangrove",
    lu_1998 == "water" ~ "Water",
    lu_1998 == "grassland" ~ "Grassland",
    lu_1998 == "exposed_soil_urban" ~ "Exposed soil / Urban",
    lu_1998 == "primary_forest" ~ "Forest",
    lu_1998 == "teak_melina" ~ "Teak / Melina",
    lu_1998 == "wetland" ~ "Wetland")) %>% 
    select(lu_1987, lu_1998, change) 

#1998 to 2019
fbs_tidy_98_19 <- raw_fbs_98_19 %>% 
    pivot_longer(!land_use:area_starting_year, names_to = "lu_2019",
               values_to = "change") %>% 
  rename("lu_1998" = land_use) %>% 
  mutate(lu_2019 = case_when(
    lu_2019 == "palm" ~ "Palm",
    lu_2019 == "mangrove" ~ "Mangrove",
    lu_2019 == "water" ~ "Water",
    lu_2019 == "grassland" ~ "Grassland",
    lu_2019 == "exposed_soil_urban" ~ "Exposed soil / Urban",
    lu_2019 == "primary_forest" ~ "Forest",
    lu_2019 == "teak_melina" ~ "Teak / Melina",
    lu_2019 == "wetland" ~ "Wetland")) %>% 
    select(lu_1998, lu_2019, change) 

#---------------------------------------
# Uncount
#---------------------------------------
# 1987 to 1998
fbs_uncount_87_98 <- fbs_tidy_87_98 %>% 
  mutate(change = round(change, digits = 0)) %>% 
  uncount(change)

# 1998 to 2019
fbs_uncount_98_19 <- fbs_tidy_98_19 %>% 
  mutate(change = round(change, digits = 0)) %>%
  uncount(change)

#---------------------------------------
# Make long
#---------------------------------------
# 1987 to 1998
# fbs_long_87_98 <- fbs_uncount_87_98 %>% 
#   make_long(lu_1987:lu_1998)

# 1998 to 2019
# fbs_long_98_19 <- fbs_uncount_98_19 %>% 
#   make_long(lu_1998:lu_2019)

#---------------------------------------
# Combine
#---------------------------------------
# Export to run combiner.exe
# write.csv(fbs_uncount_87_98,"set1.csv")
# write.csv(fbs_uncount_98_19,"set2.csv")

# Read in combined csvs
fbs_combined <- read.csv(here("Intermediate Data", "Fbs", "combinedSet.csv")) %>% 
  replace_with_na(replace = list(lu_1987 = "n/a")) 

# Make long
fbs_long_combined <- fbs_combined %>% 
  make_long(lu_1987:lu_2019)

```

### Fonafifo

```{r, cache=TRUE}
#---------------------------------------
# Tidy Data
#---------------------------------------
#1987 to 1998
fonafifo_tidy_87_98 <- raw_fonafifo_87_98 %>% 
    pivot_longer(!land_use:area_starting_year, names_to = "lu_1998",
               values_to = "change") %>% 
  rename("lu_1987" = land_use) %>% 
  mutate(lu_1998 = case_when(
    lu_1998 == "palm" ~ "Palm",
    lu_1998 == "mangrove" ~ "Mangrove",
    lu_1998 == "water" ~ "Water",
    lu_1998 == "grassland" ~ "Grassland",
    lu_1998 == "exposed_soil_urban" ~ "Exposed soil / Urban",
    lu_1998 == "primary_forest" ~ "Forest",
    lu_1998 == "teak_melina" ~ "Teak / Melina",
    lu_1998 == "wetland" ~ "Wetland")) %>% 
    select(lu_1987, lu_1998, change) 

#1998 to 2019
fonafifo_tidy_98_19 <- raw_fonafifo_98_19 %>% 
    pivot_longer(!land_use:area_starting_year, names_to = "lu_2019",
               values_to = "change") %>% 
  rename("lu_1998" = land_use) %>% 
  mutate(lu_2019 = case_when(
    lu_2019 == "palm" ~ "Palm",
    lu_2019 == "mangrove" ~ "Mangrove",
    lu_2019 == "water" ~ "Water",
    lu_2019 == "grassland" ~ "Grassland",
    lu_2019 == "exposed_soil_urban" ~ "Exposed soil / Urban",
    lu_2019 == "primary_forest" ~ "Forest",
    lu_2019 == "teak_melina" ~ "Teak / Melina",
    lu_2019 == "wetland" ~ "Wetland")) %>% 
    select(lu_1998, lu_2019, change) 

#---------------------------------------
# Uncount
#---------------------------------------
# 1987 to 1998
fonafifo_uncount_87_98 <- fonafifo_tidy_87_98 %>% 
  mutate(change = round(change, digits = 0)) %>% 
  uncount(change)

# 1998 to 2019
fonafifo_uncount_98_19 <- fonafifo_tidy_98_19 %>% 
  mutate(change = round(change, digits = 0)) %>%
  uncount(change)

#---------------------------------------
# Make long
#---------------------------------------
# 1987 to 1998
# fonafifo_long_87_98 <- fonafifo_uncount_87_98 %>% 
#   make_long(lu_1987:lu_1998)

# 1998 to 2019
# fonafifo_long_98_19 <- fonafifo_uncount_98_19 %>% 
#   make_long(lu_1998:lu_2019)

#---------------------------------------
# Combine
#---------------------------------------
# Export to run combiner.exe
# write.csv(fonafifo_uncount_87_98,"set1.csv")
# write.csv(fonafifo_uncount_98_19,"set2.csv")

# Read in combined csvs
fonafifo_combined <- read.csv(here("Intermediate Data", "Fonafifo", "combinedSet.csv")) %>% 
  replace_with_na(replace = list(lu_1987 = "n/a")) 

# Make long
fonafifo_long_combined <- fonafifo_combined %>% 
  make_long(lu_1987:lu_2019)

```

```{r}
#---------------------------------------
# Plots
#---------------------------------------

# Corcovado
#---------------------------------------
corcovado_plot <- ggplot(data = corcovado_long_combined, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node))) +
  geom_sankey(flow.alpha = 0.75, node.color = "gray30") +
  scale_x_discrete(labels = c("lu_1987" = "1987", "lu_1998" = "1998", "lu_2019" = "2019")) +
  scale_fill_manual(values = class_pallete) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(size = 14, face = "bold"),
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

corcovado_plot

# Save
ggsave(here("Images", "corcovado_sankey.jpeg"), corcovado_plot, width = 8, height = 7)

# Fbs
#---------------------------------------
fbs_plot <- ggplot(data = fbs_long_combined, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node))) +
  geom_sankey(flow.alpha = 0.75, node.color = "gray30") +
  scale_x_discrete(labels = c("lu_1987" = "1987", "lu_1998" = "1998", "lu_2019" = "2019")) +
  scale_fill_manual(values = class_pallete) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(size = 14, face = "bold"),
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fbs_plot

# Save
ggsave(here("Images", "fbs_sankey.jpeg"), fbs_plot, width = 8, height = 7)

# Fonafifo
#---------------------------------------
fonafifo_plot <- ggplot(data = fonafifo_long_combined, aes(x = x, 
               next_x = next_x, 
               node = node, 
               next_node = next_node,
               fill = factor(node))) +
  geom_sankey(flow.alpha = 0.75, node.color = "gray30") +
  scale_x_discrete(labels = c("lu_1987" = "1987", "lu_1998" = "1998", "lu_2019" = "2019")) +
  scale_fill_manual(values = class_pallete) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_blank(),
    axis.text.x = element_text(size = 14, face = "bold"),
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.background = element_rect(fill = "white", color = NA),
    rect = element_rect(fill = "white", color = NA)
  )

fonafifo_plot

# Save
ggsave(here("Images", "fonafifo_sankey.jpeg"), fonafifo_plot, width = 8, height = 7)
```

